<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus | Dynamic Research GraphRAG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg: #0b0f1a; --card: #161b2c; --accent: #00d4ff; --gold: #ffcc00; --text: #e2e8f0; }
        body { background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
        
        /* Layout */
        .app-wrapper { display: grid; grid-template-columns: 280px 1fr 400px; height: 100vh; }
        .sidebar { background: var(--card); border-right: 1px solid #2d334a; padding: 2rem; }
        .main-chat { display: flex; flex-direction: column; background: radial-gradient(circle at top right, #1a2035, #0b0f1a); }
        .research-sidebar { background: rgba(22, 27, 44, 0.5); border-left: 1px solid #2d334a; padding: 1.5rem; backdrop-filter: blur(10px); }

        /* Components */
        .chat-scroll { flex: 1; overflow-y: auto; padding: 2rem; scrollbar-width: none; }
        .message-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; animation: fadeIn 0.4s ease-out; }
        .user-tag { color: var(--accent); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; display: block; }
        
        .deep-dive-box { border-left: 3px solid var(--gold); background: rgba(255, 204, 0, 0.05); padding: 1rem; border-radius: 0 8px 8px 0; margin-top: 1rem; }
        
        input#query { background: #1f263d; border: 1px solid #3d4663; color: white; border-radius: 12px; padding: 1rem 1.5rem; }
        .stats-badge { background: #242b42; padding: 10px; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #3d4663; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app-wrapper">
    <aside class="sidebar">
        <h4 class="mb-4 text-white fw-bold">NEXUS <span style="color:var(--accent)">.</span></h4>
        <div class="stats-badge">
            <small class="text-muted d-block">Knowledge Nodes</small>
            <span id="node-count" class="h5 text-info">--</span>
        </div>
        <div class="stats-badge">
            <small class="text-muted d-block">Logical Edges</small>
            <span id="rel-count" class="h5 text-info">--</span>
        </div>
        <hr class="my-4 border-secondary">
        <button class="btn btn-outline-info w-100 mb-2" onclick="location.reload()">Refresh Data</button>
        <button class="btn btn-outline-danger w-100" onclick="resetGraph()">Wipe Nexus</button>
    </aside>

    <main class="main-chat">
        <div class="chat-scroll" id="chat-window">
            <div class="message-card">
                <span class="user-tag">System Initialization</span>
                Welcome, Researcher. Connect your modules and query the graph for structural insights.
            </div>
        </div>

        <div class="p-4 bg-transparent">
            <div class="input-group">
                <input type="text" id="query" class="form-control" placeholder="Query the Knowledge Graph..." onkeypress="if(event.key === 'Enter') askQuestion()">
                <button class="btn btn-info ms-2 px-4 rounded-3" onclick="askQuestion()">Execute</button>
            </div>
        </div>
    </main>

    <aside class="research-sidebar">
        <h6 class="text-uppercase text-muted mb-4 small fw-bold">Reasoning Chain</h6>
        <div id="status-log" class="small text-secondary">
            Waiting for query execution...
        </div>
    </aside>
</div>

<script>
    async function updateStats() {
        const res = await fetch('/stats');
        const data = await res.json();
        document.getElementById('node-count').innerText = data.nodes;
        document.getElementById('rel-count').innerText = data.relationships;
    }
    updateStats();

    async function askQuestion() {
        const queryInput = document.getElementById('query');
        const query = queryInput.value;
        const chatWindow = document.getElementById('chat-window');
        const statusLog = document.getElementById('status-log');
        
        if(!query) return;

        chatWindow.innerHTML += `<div class="message-card"><span class="user-tag">Researcher</span>${query}</div>`;
        queryInput.value = '';
        statusLog.innerHTML = `<div class="spinner-border spinner-border-sm text-info"></div> <strong>Stage 1:</strong> Traversing Graph...`;

        const response = await fetch('/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
        });
        const data = await response.json();

        let diveContent = "";
        if(data.mode.includes("Deep Dive")) {
            statusLog.innerHTML = `<div class="text-warning">⚠️ Sparse Path Detected.</div><strong>Stage 2:</strong> Executing Vector Deep Dive...`;
            diveContent = `<div class="deep-dive-box"><small class="text-warning fw-bold">AUTONOMOUS DEEP DIVE TRIGGERED</small><br>Scanning raw document chunks to bridge structural gaps.</div>`;
        } else {
            statusLog.innerHTML = `<div class="text-success">✓ Logic Found in Graph.</div>Analysis synthesized.`;
        }

        chatWindow.innerHTML += `
            <div class="message-card">
                <span class="user-tag" style="color:var(--accent)">Nexus Analysis</span>
                ${diveContent}
                <div class="mt-3">${marked.parse(data.answer)}</div>
            </div>
        `;
        chatWindow.scrollTop = chatWindow.scrollHeight;
        updateStats();
    }
</script>
</body>
</html>